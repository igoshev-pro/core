services:
  mongo:
    image: mongo:7
    container_name: core_mongo_dev
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-root}
    volumes:
      - mongo_data_dev:/data/db

  api:
    image: node:20-alpine
    container_name: core_api_dev
    working_dir: /app
    command: ["sh", "-lc", "corepack enable && corepack prepare pnpm@9.0.0 --activate && pnpm install && pnpm run start:dev"]
    ports:
      - "3001:3000"
    environment:
      NODE_ENV: development
      PORT: "3000"
      MONGO_URI: mongodb://${MONGO_ROOT_USER:-root}:${MONGO_ROOT_PASSWORD:-root}@mongo:27017/${MONGO_DB:-app}?authSource=admin
      MONGO_URI_FIRST_PART: mongodb://root:root@localhost:27017/
      MONGO_URI_LAST_PART: ?retryWrites=?authSource=admin
      SMTP_HOST: ${SMTP_HOST:-smtp.ionos.de}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-support@igoshev.pro}
      SMTP_PASS: ${SMTP_PASS:-vezxA7-higzym-niqpis}
      SMTP_FROM: ${SMTP_FROM:-no-reply@igoshev.pro}
      S3_ENDPOINT: https://s3.twcstorage.ru
      S3_REGION: ru-1
      S3_ACCESS_KEY: TJ2FIIYJ96L8D5ECRHTN
      S3_SECRET_KEY: pq1n4q220WeDRJXSBGjCxjanOsI6DZ1fpKDGVGn4
      S3_BUCKET: 87256dd2-5c833240-a13a-40bb-9b9c-641734629be3
      S3_FORCE_PATH_STYLE: true
      REDIS_URL: redis://redis:6379
      CORE_INTERNAL_TOKEN: X9!rK2@Fq7gMZs4A
    volumes:
      - ./apps/api:/app
      - pnpm_store_api:/pnpm-store
      - node_modules_api:/app/node_modules
    depends_on:
      - mongo

  web:
    image: node:20-alpine
    container_name: core_web_dev
    working_dir: /app
    command: ["sh", "-lc", "corepack enable && corepack prepare pnpm@9.0.0 --activate && pnpm install && pnpm run dev"]
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: development
      NEXT_PUBLIC_API_URL: http://localhost:3001
      CHOKIDAR_USEPOLLING: "true"
      WATCHPACK_POLLING: "true"
      API_URL: https://api.igoshev.pro
      CORE_API_URL: https://api.igoshev.pro/core
      CURRENT_DEV_PROJECT_ID: 694900375118e605d8b89551
      CORE_INTERNAL_TOKEN: X9!rK2@Fq7gMZs4A
    volumes:
      - ./apps/web:/app
      - pnpm_store_web:/pnpm-store
      - node_modules_web:/app/node_modules
    depends_on:
      - api

  redis:
    image: redis:7-alpine
    container_name: saas_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data

volumes:
  mongo_data_dev:
  pnpm_store_api:
  pnpm_store_web:
  node_modules_api:
  node_modules_web:
  redis_data: